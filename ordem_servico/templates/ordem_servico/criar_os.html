{% extends 'principal/base.html' %}
{% block title %}Cadastrar Ordem de Serviço{% endblock %}

{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header {% if message.tags == 'error' %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
            <h5 class="modal-title" id="messageModalLabel">
              {% if message.tags == 'error' %}Erro{% else %}Sucesso{% endif %}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            {{ message }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        modal.show();
      });
    </script>
  {% endfor %}
{% endif %}


<style>
  
   .form-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #343a40;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.25rem;
  }
  .form-label {
    font-weight: 500;
    font-size: 0.825rem;
  }
  .form-control, .form-select {
    font-size: 0.825rem;
    padding: 0.4rem 0.5rem;
  }
  .form-group {
    margin-bottom: 0.75rem;
  }
  .btn-lg {
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
  }
  .card-collapse {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
  }
  .card-collapse .card-header {
    background-color: #f8f9fa;
    cursor: pointer;
    font-weight: 500;
    padding: 0.6rem 1rem;
  }
  .card-collapse .card-body {
    padding: 1rem;
  }

  .nav-tabs .nav-link {
    color: black;
    font-weight: 500;
  }

  .nav-tabs .nav-link.active {
    background-color: #343a40;
    border-color: #dee2e6 #dee2e6 #fff;
    color: white;
  }

  #formTabs {
  overflow-x: unset !important;
  white-space: normal !important;
  flex-wrap: wrap !important;
}
.form-despesa {
  display: none;
  margin-top: 20px;
}
</style>

<div class="container py-3">
  <h2 class="mb-3">Gerar Nova Ordem de Serviço</h2>
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="border rounded" style="padding: 10px; padding-top: 0px; background-color:#f8f8f8; border-radius: 10px;">
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs  " id="formTabs" role="tablist" style="overflow-x: auto; white-space: nowrap; ">
          <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="identificacao-tab" data-bs-toggle="tab" data-bs-target="#identificacao" type="button" role="tab">
              <i class="fas fa-id-card"></i> Identificação
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="obra-tab" data-bs-toggle="tab" data-bs-target="#obra" type="button" role="tab">
              <i class="fas fa-tools"></i> Obra
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab">
              <i class="fas fa-box"></i> Produtos
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="servicos-tab" data-bs-toggle="tab" data-bs-target="#servicos" type="button" role="tab">
              <i class="fas fa-briefcase"></i> Serviços
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="despesas-tab" data-bs-toggle="tab" data-bs-target="#despesas" type="button" role="tab">
              <i class="fas fa-file-invoice-dollar"></i> Despesas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2 px-4 py-2 rounded-top" id="anexo-tab" data-bs-toggle="tab" data-bs-target="#anexo" type="button" role="tab">
              <i class="fas fa-paperclip"></i> Anexo e Observação
            </button>
          </li>
        </ul>

      <!-- Tab Content -->
      <div class="tab-content  p-3" id="formTabsContent" style="background-color: #f8f8f8;">

        <!-- Identificação -->
        <div class="tab-pane fade show active" id="identificacao" role="tabpanel">
          <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-6">
                    <label for="{{ form.titulo.id_for_label }}" class="form-label-professional">Título</label>
                    {{ form.titulo }}
                    {% if form.titulo.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.titulo.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-2">
                    <label for="{{ form.status.id_for_label }}" class="form-label-professional">Status</label>
                    {{ form.status }}
                    {% if form.status.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.status.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                 
                  <div class="col-md-4">
  <label for="{{ form.n_cliente.id_for_label }}" class="form-label-professional">Cliente</label>

  <div class="input-group">
    <select id="id_n_cliente" name="n_cliente" class="form-select">
      {% for value, label in form.n_cliente.field.choices %}
        <option value="{{ value.nome_cliente }}">{{ label }}</option>
      {% endfor %}
      <option value="cadastrar">➕ Cadastrar novo cliente</option>
    </select>

    <!-- Botão pequeno para recarregar apenas o dropdown -->
    <button type="button" id="btn-recarregar-clientes" class="btn btn-outline-secondary btn-sm" title="Recarregar clientes">
      <i class="fa-solid fa-rotate-right"></i>
    </button>
  </div>

  {% if form.n_cliente.errors %}
    <div class="invalid-feedback d-block">
      {{ form.n_cliente.errors|striptags }}
    </div>
  {% endif %}
</div>

<script>
  async function atualizarClientes(selecionarId) {
    const select = document.getElementById("id_n_cliente");
    const btn = document.getElementById("btn-recarregar-clientes");
    const antigoSelecionado = selecionarId ?? select.value;
    const btnHtml = btn.innerHTML;

    // feedback rápido no botão
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    try {
      const resp = await fetch("{% url 'clientes:lista_de_clientes' %}");
      const data = await resp.json();

      // limpa e repopula
      select.innerHTML = "";
      data.forEach(cliente => {
        const option = document.createElement("option");
        option.value = cliente.id;
        option.textContent = cliente.nome_cliente;
        select.appendChild(option);
      });

      // adiciona a opção de cadastrar no final
      const optionCadastrar = document.createElement("option");
      optionCadastrar.value = "cadastrar";
      optionCadastrar.textContent = "➕ Cadastrar novo cliente";
      select.appendChild(optionCadastrar);

      // tenta manter a seleção anterior (se ainda existir)
      const existeAnterior = Array.from(select.options).some(o => o.value == antigoSelecionado);
      if (existeAnterior) {
        select.value = antigoSelecionado;
      }
    } catch (e) {
      console.error(e);
      alert("Não foi possível atualizar a lista de clientes agora.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = btnHtml;
    }
  }

  // Botão de recarregar apenas o dropdown
  document.getElementById("btn-recarregar-clientes")
    .addEventListener("click", () => atualizarClientes());

  // Ao escolher "Cadastrar", abre em nova aba (e você depois clica no botão para recarregar)
  document.getElementById("id_n_cliente")
    .addEventListener("change", function () {
      if (this.value === "cadastrar") {
        window.open("{% url 'clientes:cadastrar_clientes' %}", "_blank");
        this.value = ""; // reseta para evitar ficar selecionado
      }
    });
</script>

                </div>
                <div class="row g-2" style="margin-top: 5px;">
                  <div class="col-md-4">
                    <label for="{{ form.solicitante.id_for_label }}" class="form-label-professional">Solicitante</label>
                    {{ form.solicitante }}
                    {% if form.solicitante.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.solicitante.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label for="{{ form.unidade.id_for_label }}" class="form-label-professional">Unidade</label>
                    {{ form.unidade }}
                    {% if form.unidade.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.unidade.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>

                  <div class="col-md-2">
                    <label for="{{ form.segmento.id_for_label }}" class="form-label-professional">Segmento</label>
                    {{ form.segmento }}
                    {% if form.segmento.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.segmento.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>

                  <div class="col-md-2">
                    <label for="{{ form.n_proposta.id_for_label }}" class="form-label-professional">Nº Proposta</label>
                    {{ form.n_proposta }}
                    {% if form.n_proposta.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.n_proposta.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  
                  <div class="col-md-2">
                    <label for="{{ form.n_desenho.id_for_label }}" class="form-label-professional">Nº Desenho</label>
                    {{ form.n_desenho }}
                    {% if form.n_desenho.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.n_desenho.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
        </div>

        <!-- Obra -->
        <div class="tab-pane fade" id="obra" role="tabpanel">
          <div class="row g-2">
                  <div class="col-md-6">
                    <label for="{{ form.obra_nome.id_for_label }}" class="form-label-professional">Nome</label>
                    {{ form.obra_nome }}
                    {% if form.obra_nome.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.obra_nome.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label for="{{ form.obra_inicio.id_for_label }}" class="form-label-professional">Início</label>
                    {{ form.obra_inicio }}
                    {% if form.obra_inicio.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.obra_inicio.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label for="{{ form.obra_termino.id_for_label }}" class="form-label-professional">Término</label>
                    {{ form.obra_termino }}
                    {% if form.obra_termino.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.obra_termino.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label for="{{ form.n_art.id_for_label }}" class="form-label-professional">Nº ART</label>
                    {{ form.n_art }}
                    {% if form.n_art.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.n_art.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                </div>

                <div class="row g-2 mt-2">
                  <div class="col-md-4">
                    <label for="{{ form.municipio.id_for_label }}" class="form-label-professional">Município</label>
                    {{ form.municipio }}
                    {% if form.municipio.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.municipio.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label for="{{ form.uf.id_for_label }}" class="form-label-professional">UF</label>
                    {{ form.uf }}
                    {% if form.uf.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.uf.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-3">
                    <label for="{{ form.uc_os.id_for_label }}" class="form-label-professional">UC/OS</label>
                    {{ form.uc_os }}
                    {% if form.uc_os.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.uc_os.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-3">
                    <label for="{{ form.oc.id_for_label }}" class="form-label-professional">OC</label>
                    {{ form.oc }}
                    {% if form.oc.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.oc.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                </div>
        </div>
      
        <!-- Produtos -->
        <div class="tab-pane fade" id="produtos" role="tabpanel">
          <div class="card-body">
            <div class="mb-3">
              <input type="hidden" id="id_form-TOTAL_FORMS" name="form-TOTAL_FORMS" value="1">
              <div id="produtos-container">
                <!-- Bloco Inicial -->
                <div class="row g-1 produto-form border rounded p-3 mb-3 position-relative bg-light">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label>Produto:</label>
                      <select name="form-0-produto" class="form-select produto-select">
                        <option value="">Selecione o Produto</option>
                        {% for produto in produtos %}
                          <option value="{{ produto.id }}" data-preco="{{ produto.preco }}">
                            {{ produto.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label>Quantidade:</label>
                      <input type="number" name="form-0-quantidade" required class="form-control quantidade-produto-input">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-produto" title="Remover produto">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>

                    <input type="hidden" name="form-0-acao" value="mantem" class="campo-acao" />
                  </div>
                </div>
              </div>

              <!-- Template Oculto -->
              <div id="produto-template" class="d-none">
                <div class="row g-1 produto-form border rounded p-3 mb-3 position-relative bg-light">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label>Produto:</label>
                      <select name="form-__prefix__-produto" class="form-select produto-select">
                        <option value="">Selecione o Produto</option>
                        {% for produto in produtos %}
                          <option value="{{ produto.id }}" data-preco="{{ produto.preco }}">
                            {{ produto.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label>Quantidade:</label>
                      <input type="number" name="form-__prefix__-quantidade" class="form-control quantidade-produto-input">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-produto" title="Remover produto">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                  
                    
                    <input type="hidden" name="form-__prefix__-acao" value="mantem" class="campo-acao" />
                  
                </div>
              </div>


              <!-- Botão Adicionar -->
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-produto">
                <i class="fas fa-plus"></i> Adicionar Produto
              </button>
            </div>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function () {
          let totalProdutos = 1;

          function atualizarTotalForms() {
            const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
            totalFormsInput.value = totalProdutos;
          }

          document.getElementById('add-produto').addEventListener('click', function () {
            const container = document.getElementById('produtos-container');
            const template = document.getElementById('produto-template').innerHTML;
            const newForm = template.replace(/__prefix__/g, totalProdutos);
            container.insertAdjacentHTML('beforeend', newForm);
            totalProdutos++;
            atualizarTotalForms();
          });

          document.getElementById('produtos-container').addEventListener('click', function (e) {
            if (e.target.closest('.btn-remove-produto')) {
              const bloco = e.target.closest('.produto-form');
              if (bloco) {
                bloco.remove();

                // Atualiza o total de formulários visíveis
                totalProdutos = document.querySelectorAll('.produto-form').length;
                atualizarTotalForms();
              }
            }
          });
        });
        </script>

        <!-- Serviços -->
        <div class="tab-pane fade" id="servicos" role="tabpanel">
          <div class="card-body">
            <div class="mb-3">
              <input type="hidden" name="servico-TOTAL_FORMS" id="id_servico-TOTAL_FORMS" value="1">
              <div id="servicos-container">
                <!-- Bloco Inicial -->
                <div class="row g-1 servico-form border rounded p-3 mb-3 position-relative bg-light">
                  <div class="row g-2">
                    <div class="col-md-5">
                      <label>Serviço:</label>
                      <select name="form-0-servico" class="form-select servico-select">
                        <option value="">Selecione o Serviço</option>
                        {% for servico in servicos %}
                          <option value="{{ servico.id }}" data-preco="{{ servico.preco }}">
                            {{ servico.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-5">
                      <label>Profissional:</label>
                      <select name="form-0-tecnico" class="form-select tecnico-select">
                        <option value="">Selecione o Profissional</option>
                        {% for tecnico in tecnicos %}
                          <option value="{{ tecnico.id }}" data-preco="{{ tecnico.comissao }}">
                            {{ tecnico.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-servico" title="Remover serviço">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-2">
                      <label>Quantidade:</label>
                      <input type="number" name="form-0-quantidade-servico" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label>Preço Unitário:</label>
                      <input type="text" name="form-0-preco_unitario" class="form-control preco-servico-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Preço Total:</label>
                      <input type="text" name="form-0-preco_total" class="form-control preco-total-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Comissão:</label>
                      <input type="text" name="form-0-comissao" class="form-control comissao-tecnico-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Comissão Total:</label>
                      <input type="text" name="form-0-comissao_total" class="form-control comissao-total-input" readonly>
                    </div>
                    <input type="hidden" name="form-0-acao-servico" value="mantem" class="campo-acao" />
                  </div>
                </div>
              </div>

              <!-- Template Oculto -->
              <div id="servico-template" class="d-none">
                <div class="row g-1 servico-form border rounded p-3 mb-3 position-relative bg-light">
                  <div class="row g-2">
                    <div class="col-md-5">
                      <label>Serviço:</label>
                      <select name="form-__prefix__-servico" class="form-select servico-select">
                        <option value="">Selecione o Serviço</option>
                        {% for servico in servicos %}
                          <option value="{{ servico.id }}" data-preco="{{ servico.preco }}">
                            {{ servico.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-5">
                      <label>Profissional:</label>
                      <select name="form-__prefix__-tecnico" class="form-select tecnico-select">
                        <option value="">Selecione o Profissional</option>
                        {% for tecnico in tecnicos %}
                          <option value="{{ tecnico.id }}" data-preco="{{ tecnico.comissao }}">
                            {{ tecnico.nome }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-servico" title="Remover serviço">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-2">
                      <label>Quantidade:</label>
                      <input type="number" name="form-__prefix__-quantidade-servico" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label>Preço Unitário:</label>
                      <input type="text" name="form-__prefix__-preco_unitario" class="form-control preco-servico-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Preço Total:</label>
                      <input type="text" name="form-__prefix__-preco_total" class="form-control preco-total-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Comissão:</label>
                      <input type="text" name="form-__prefix__-comissao" class="form-control comissao-tecnico-input" readonly>
                    </div>
                    <div class="col-md-2">
                      <label>Comissão Total:</label>
                      <input type="text" name="form-__prefix__-comissao_total" class="form-control comissao-total-input" readonly>
                    </div>
                    <input type="hidden" name="form-__prefix__-acao-servico" value="mantem" class="campo-acao" />
                  </div>
                </div>
              </div>

              <!-- Botão Adicionar -->
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-servico">
                <i class="fas fa-plus"></i> Adicionar Serviço
              </button>
            </div>
          </div>
        </div>

        <script>
          function aplicarEventosNosServicos() {
            document.querySelectorAll('.servico-form').forEach(function(form) {
              const selectServico = form.querySelector('.servico-select');
              const selectTecnico = form.querySelector('.tecnico-select');
              const quantidadeInput = form.querySelector('input[name$="quantidade-servico"]');
              const precoUnitarioInput = form.querySelector('.preco-servico-input');
              const precoTotalInput = form.querySelector('.preco-total-input');
              const comissaoInput = form.querySelector('.comissao-tecnico-input');
              const comissaoTotalInput = form.querySelector('.comissao-total-input');

              function calcular() {
                const precoServico = parseFloat(selectServico.selectedOptions[0]?.dataset.preco || 0);
                const comissaoTecnico = parseFloat(selectTecnico.selectedOptions[0]?.dataset.preco || 0);
                const quantidade = parseFloat(quantidadeInput.value || 0);

                const precoTotal = precoServico * quantidade;
                const comissao = (comissaoTecnico / 100) * precoServico;
                const comissaoTotal = (comissaoTecnico / 100) * precoTotal;

                precoUnitarioInput.value = precoServico.toFixed(2);
                precoTotalInput.value = precoTotal.toFixed(2);
                comissaoInput.value = comissao.toFixed(2);
                comissaoTotalInput.value = comissaoTotal.toFixed(2);
              }

              selectServico.addEventListener('change', calcular);
              selectTecnico.addEventListener('change', calcular);
              quantidadeInput.addEventListener('input', calcular);
            });
          }

          document.addEventListener('DOMContentLoaded', function() {
            aplicarEventosNosServicos();

            document.getElementById('add-servico')?.addEventListener('click', function() {
              const container = document.getElementById('servicos-container');
              const template = document.getElementById('servico-template').innerHTML;
              const totalFormsInput = document.getElementById('id_servico-TOTAL_FORMS');
              let formsCount = parseInt(totalFormsInput.value);

              const novoHtml = template.replace(/__prefix__/g, formsCount);
              container.insertAdjacentHTML('beforeend', novoHtml);

              totalFormsInput.value = formsCount + 1;
              aplicarEventosNosServicos();
            });

          });
        </script>

        <!-- Script -->
        <script>
          document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-remove-servico')) {
              e.target.closest('.servico-form').remove();
            }
          });
        </script>

        <div class="tab-pane fade" id="despesas" role="tabpanel">
          <div class="row row-cols-2 row-cols-md-4 g-3">
            {% for nome in nomes %}
            <div class="col">
              <a href="#" class="text-decoration-none" onclick="mostrarFormulario('{{ nome|slugify }}')">
                <div class="card text-center h-100 shadow-sm">
                  <div class="card-body">
                    {{ nome }}
                  </div>
                </div>
              </a>
            </div>
            {% endfor %}
          </div>

          <!-- Formulários escondidos por padrão -->
          <div id="formularios-despesas">
            {% for nome in nomes %}
            <div id="form-{{ nome|slugify }}" class="form-despesa card shadow-sm p-3">
              <h5>{{ nome }}</h5>
              
              <div class="clonavel-{{ nome|slugify }}">
                <div class="row g-2 mb-3 input-bloco">
                  <div class="col-md-4">
                    <label class="form-label">Descrição</label>
                    <input type="text" class="form-control" name="descricao_{{ nome|slugify }}">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control quantidade" name="quantidade_{{ nome|slugify }}">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Preço Unitário</label>
                    <input type="number" step="0.01" class="form-control preco_unitario" name="preco_unitario_{{ nome|slugify }}">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Preço Total</label>
                    <input type="number" step="0.01" class="form-control preco_total" name="preco_total_{{ nome|slugify }}" readonly>
                  </div>
                  <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm btn-remove-despesa" title="Remover despesa">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-primary mt-2" onclick="clonarBloco('{{ nome|slugify }}')">
                Adicionar
              </button>
            </div>
            {% endfor %}
          </div>

          <script>
            document.addEventListener('input', function(e) {
              // Verifica se o input alterado foi de quantidade ou preço unitário
              if (e.target.classList.contains('quantidade') || e.target.classList.contains('preco_unitario')) {
                const linha = e.target.closest('.input-bloco');  // pega o bloco onde o input está
                if (linha) {
                  const quantidade = parseFloat(linha.querySelector('.quantidade')?.value) || 0;
                  const precoUnitario = parseFloat(linha.querySelector('.preco_unitario')?.value) || 0;
                  const precoTotal = linha.querySelector('.preco_total');
                  if (precoTotal) {
                    precoTotal.value = (quantidade * precoUnitario).toFixed(2);
                  }
                }
              }
            });
          </script>

          <script>
            function clonarBloco(tipo) {
              const container = document.querySelector('.clonavel-' + tipo);
              const blocos = container.querySelectorAll('.input-bloco');
              const ultimoBloco = blocos[blocos.length - 1];
              const novoBloco = ultimoBloco.cloneNode(true);

              // Limpa os inputs do novo bloco
              novoBloco.querySelectorAll('input').forEach(input => input.value = '');

              container.appendChild(novoBloco);
            }
          </script>

          <script>
            function mostrarFormulario(id) {
              // Oculta todos os formulários primeiro
              document.querySelectorAll('.form-despesa').forEach(div => div.style.display = 'none');
              // Exibe o formulário correspondente
              const form = document.getElementById('form-' + id);
              if (form) {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth' });
              }
            }
          </script>

          <script>
            document.addEventListener('click', function (event) {
              if (event.target.closest('.btn-remove-despesa')) {
                const bloco = event.target.closest('.input-bloco');
                if (bloco) {
                  bloco.remove();
                }
              }
            });
          </script>

        </div>

        <!-- Anexo e Observação -->
        <div class="tab-pane fade" id="anexo" role="tabpanel">
          <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-12">
                    <label for="{{ form.arquivo.id_for_label }}" class="form-label-professional">Arquivo</label>
                    {{ form.arquivo }}
                    {% if form.arquivo.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.arquivo.errors|striptags }}
                    </div>
                    {% endif %}
                  </div> 
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-md-12">
                    <label for="{{ form.descricao.id_for_label }}" class="form-label-professional">Descrição</label>
                    {{ form.descricao }}
                    {% if form.descricao.errors %}
                    <div class="invalid-feedback d-block">
                      {{ form.descricao.errors|striptags }}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
        </div>
      </div>
    </div>

    <div class="text-end mt-3">
      <button type="submit" class="btn btn-dark-custom btn-sm w-auto">
        <i class="fas fa-save me-2"></i>Salvar Os
      </button>
    </div>
  </form>
</div>







{% endblock %}
