{% extends 'principal/base.html' %}
{% block title %}Cadastrar Cliente{% endblock %}

{% block content %}

<style>
  
   .form-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #343a40;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.25rem;
  }
  .form-label {
    font-weight: 500;
    font-size: 0.825rem;
  }
  .form-control, .form-select {
    font-size: 0.825rem;
    padding: 0.4rem 0.5rem;
  }
  .form-group {
    margin-bottom: 0.75rem;
  }
  .btn-lg {
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
  }
  .card-collapse {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
  }
  .card-collapse .card-header {
    background-color: #f8f9fa;
    cursor: pointer;
    font-weight: 500;
    padding: 0.6rem 1rem;
  }
  .card-collapse .card-body {
    padding: 1rem;
  }
</style>

<div class="container py-3">
  <h2 class="mb-3">Gerar Nova Ordem de Serviço</h2>
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="accordion" id="formAccordion">
      <!-- seus outros blocos aqui (Identificação, Obra, etc) -->
      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#identificacao" aria-expanded="true">
          Identificação
        </div>
        <div id="identificacao" class="collapse show" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label for="{{ form.titulo.id_for_label }}" class="form-label-professional">Título</label>
                {{ form.titulo }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.data_abertura.id_for_label }}" class="form-label-professional">Data da Abertura</label>
                {{ form.data_abertura }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.status.id_for_label }}" class="form-label-professional">Status</label>
                {{ form.status }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.digitador.id_for_label }}" class="form-label-professional">Digitador</label>
                {{ form.digitador }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.n_cliente.id_for_label }}" class="form-label-professional">Cliente</label>
                {{ form.n_cliente }}
              </div>
            </div>
            <div class="row g-2" style="margin-top: 5px;">
              <div class="col-md-4">
                <label for="{{ form.solicitante.id_for_label }}" class="form-label-professional">Solicitante</label>
                {{ form.solicitante }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.unidade.id_for_label }}" class="form-label-professional">Unidade</label>
                {{ form.unidade }}
              </div>

              <div class="col-md-2">
                <label for="{{ form.segmento.id_for_label }}" class="form-label-professional">Segmento</label>
                {{ form.segmento }}
              </div>

              <div class="col-md-2">
                <label for="{{ form.n_proposta.id_for_label }}" class="form-label-professional">Nº Proposta</label>
                {{ form.n_proposta }}
              </div>
              
              <div class="col-md-2">
                <label for="{{ form.n_desenho.id_for_label }}" class="form-label-professional">Nº Desenho</label>
                {{ form.n_desenho }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#contato_doc">
          Obra
        </div>
        <div id="contato_doc" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">

            <!-- Campos da Obra -->
            <div class="row g-2">
              <div class="col-md-6">
                <label for="{{ form.obra_nome.id_for_label }}" class="form-label-professional">Nome</label>
                {{ form.obra_nome }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.obra_inicio.id_for_label }}" class="form-label-professional">Início</label>
                {{ form.obra_inicio }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.obra_termino.id_for_label }}" class="form-label-professional">Término</label>
                {{ form.obra_termino }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.n_art.id_for_label }}" class="form-label-professional">Nº ART</label>
                {{ form.n_art }}
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label for="{{ form.municipio.id_for_label }}" class="form-label-professional">Município</label>
                {{ form.municipio }}
              </div>
              <div class="col-md-2">
                <label for="{{ form.uf.id_for_label }}" class="form-label-professional">UF</label>
                {{ form.uf }}
              </div>
              <div class="col-md-3">
                <label for="{{ form.uc_os.id_for_label }}" class="form-label-professional">UC/OS</label>
                {{ form.uc_os }}
              </div>
              <div class="col-md-3">
                <label for="{{ form.oc.id_for_label }}" class="form-label-professional">OC</label>
                {{ form.oc }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- PRODUTOS -->
      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#produtos">
          Produtos
        </div>
        <div id="produtos" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="mb-3">
              {{ produto_formset.management_form }}
              <div id="produtos-container">
                {% for produto_form in produto_formset %}
                  <div class="row g-2 produto-form border rounded p-2 mb-3 position-relative">
                    <div class="col-md-6">
                      {{ produto_form.produto.label_tag }} {{ produto_form.produto }}
                    </div>
                    <div class="col-md-3">
                      {{ produto_form.quantidade.label_tag }} {{ produto_form.quantidade }}
                    </div>
                    <!-- Campo DELETE oculto -->
                    <input type="hidden" name="form-{{ forloop.counter0 }}-acao" value="mantem" class="campo-acao" />
                    <!-- Botão de excluir -->
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-2 btn-remove-produto" title="Remover produto"></button>
                  </div>
                {% endfor %}
              </div>

              <!-- TEMPLATE OCULTO para clonagem -->
              <div id="produto-template" class="row g-2 produto-form border rounded p-2 mb-3 position-relative" style="display:none;">
                <div class="col-md-6">
                  <label for="id_form-__prefix__-produto">Produto</label>
                  <select name="form-__prefix__-produto" id="id_form-__prefix__-produto" class="form-select"></select>
                </div>
                <div class="col-md-3">
                  <label for="id_form-__prefix__-quantidade">Quantidade</label>
                  <input type="number" name="form-__prefix__-quantidade" id="id_form-__prefix__-quantidade" class="form-control" />
                </div>

                <!-- Campo personalizado de ação -->
                <input type="hidden" name="form-__prefix__-acao" value="mantem" class="campo-acao" />

                <!-- Botão de excluir -->
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2 btn-remove-produto" title="Remover produto"></button>
              </div>

              <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-produto">+ Adicionar Produto</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Anexo e Observação -->
      <!-- ... seus outros blocos -->
      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#seg_ativ_obs">
          Anexo e Observação
        </div>
        <div id="seg_ativ_obs" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-12">
                <label for="{{ form.arquivo.id_for_label }}" class="form-label-professional">Arquivo</label>
                {{ form.arquivo }}
              </div> 
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-12">
                <label for="{{ form.descricao.id_for_label }}" class="form-label-professional">Descrição</label>
                {{ form.descricao }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-end mt-3">
      <button type="submit" class="btn btn-dark-custom btn-sm w-auto">
        <i class="fas fa-save me-2"></i>Salvar Cliente
      </button>
    </div>
  </form>
</div>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.getElementById('produtos-container');
  const addBtn = document.getElementById('add-produto');
  const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
  const template = document.getElementById('produto-template');
  const form = document.querySelector('form');

function atualizarEventosRemocao() {
  const botoes = container.querySelectorAll('.btn-remove-produto');
  botoes.forEach(btn => {
    btn.onclick = function () {
      const formRow = btn.closest('.produto-form');
      const acaoField = formRow.querySelector('input.campo-acao');
      if (acaoField) {
        acaoField.value = 'delete';
      }
      formRow.style.display = 'none';
    };
  });
}
  addBtn.addEventListener('click', function () {
    const formCount = parseInt(totalForms.value);

    // Clona o template oculto
    const newForm = template.cloneNode(true);
    newForm.style.display = 'flex';
    newForm.id = "";

    // Substitui __prefix__ por formCount
    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formCount);

    // Corrige atributos for, name e id
    newForm.querySelectorAll('input, select, label').forEach(el => {
      if (el.hasAttribute('for')) {
        el.setAttribute('for', el.getAttribute('for').replace('__prefix__', formCount));
      }
      if (el.name) {
        el.name = el.name.replace('__prefix__', formCount);
      }
      if (el.id) {
        el.id = el.id.replace('__prefix__', formCount);
      }
    });

    // Copiar opções do primeiro select real para o novo
    const primeiroSelect = container.querySelector('select');
    const novoSelect = newForm.querySelector('select');
    if (primeiroSelect && novoSelect) {
      novoSelect.innerHTML = primeiroSelect.innerHTML;
    }

    container.appendChild(newForm);
    totalForms.value = formCount + 1;
    atualizarEventosRemocao();
  });

  form.addEventListener('submit', function () {
    // Garante que todos os campos DELETE marcados sejam habilitados
    const deletes = container.querySelectorAll('input[type="checkbox"][name$="-DELETE"]');
    deletes.forEach(input => {
      if (input.checked) {
        input.disabled = false;
      }
    });
  });

  atualizarEventosRemocao();
});
</script>


{% endblock %}
