{% extends 'principal/base.html' %}
{% block title %}Cadastrar Ordem de Serviço{% endblock %}

{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header {% if message.tags == 'error' %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
            <h5 class="modal-title" id="messageModalLabel">
              {% if message.tags == 'error' %}Erro{% else %}Sucesso{% endif %}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            {{ message }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        modal.show();
      });
    </script>
  {% endfor %}
{% endif %}


<style>
  
   .form-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #343a40;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.25rem;
  }
  .form-label {
    font-weight: 500;
    font-size: 0.825rem;
  }
  .form-control, .form-select {
    font-size: 0.825rem;
    padding: 0.4rem 0.5rem;
  }
  .form-group {
    margin-bottom: 0.75rem;
  }
  .btn-lg {
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
  }
  .card-collapse {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
  }
  .card-collapse .card-header {
    background-color: #f8f9fa;
    cursor: pointer;
    font-weight: 500;
    padding: 0.6rem 1rem;
  }
  .card-collapse .card-body {
    padding: 1rem;
  }
</style>

<div class="container py-3">
  <h2 class="mb-3">Gerar Nova Ordem de Serviço</h2>
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="accordion" id="formAccordion">
      <!-- seus outros blocos aqui (Identificação, Obra, etc) -->
      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#identificacao" aria-expanded="true">
          Identificação
        </div>
        <div id="identificacao" class="collapse show" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label for="{{ form.titulo.id_for_label }}" class="form-label-professional">Título</label>
                {{ form.titulo }}
                {% if form.titulo.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.titulo.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.data_abertura.id_for_label }}" class="form-label-professional">Data da Abertura</label>
                {{ form.data_abertura }}
                {% if form.data_abertura.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.data_abertura.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.status.id_for_label }}" class="form-label-professional">Status</label>
                {{ form.status }}
                {% if form.status.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.status.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.digitador.id_for_label }}" class="form-label-professional">Digitador</label>
                {{ form.digitador }}
                {% if form.digitador.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.digitador.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.n_cliente.id_for_label }}" class="form-label-professional">Cliente</label>
                {{ form.n_cliente }}
                {% if form.n_cliente.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.n_cliente.errors|striptags }}
                </div>
                {% endif %}
              </div>
            </div>
            <div class="row g-2" style="margin-top: 5px;">
              <div class="col-md-4">
                <label for="{{ form.solicitante.id_for_label }}" class="form-label-professional">Solicitante</label>
                {{ form.solicitante }}
                {% if form.solicitante.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.solicitante.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.unidade.id_for_label }}" class="form-label-professional">Unidade</label>
                {{ form.unidade }}
                {% if form.unidade.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.unidade.errors|striptags }}
                </div>
                {% endif %}
              </div>

              <div class="col-md-2">
                <label for="{{ form.segmento.id_for_label }}" class="form-label-professional">Segmento</label>
                {{ form.segmento }}
                {% if form.segmento.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.segmento.errors|striptags }}
                </div>
                {% endif %}
              </div>

              <div class="col-md-2">
                <label for="{{ form.n_proposta.id_for_label }}" class="form-label-professional">Nº Proposta</label>
                {{ form.n_proposta }}
                {% if form.n_proposta.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.n_proposta.errors|striptags }}
                </div>
                {% endif %}
              </div>
              
              <div class="col-md-2">
                <label for="{{ form.n_desenho.id_for_label }}" class="form-label-professional">Nº Desenho</label>
                {{ form.n_desenho }}
                {% if form.n_desenho.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.n_desenho.errors|striptags }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#contato_doc">
          Obra
        </div>
        <div id="contato_doc" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">

            <!-- Campos da Obra -->
            <div class="row g-2">
              <div class="col-md-6">
                <label for="{{ form.obra_nome.id_for_label }}" class="form-label-professional">Nome</label>
                {{ form.obra_nome }}
                {% if form.obra_nome.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.obra_nome.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.obra_inicio.id_for_label }}" class="form-label-professional">Início</label>
                {{ form.obra_inicio }}
                {% if form.obra_inicio.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.obra_inicio.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.obra_termino.id_for_label }}" class="form-label-professional">Término</label>
                {{ form.obra_termino }}
                {% if form.obra_termino.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.obra_termino.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.n_art.id_for_label }}" class="form-label-professional">Nº ART</label>
                {{ form.n_art }}
                {% if form.n_art.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.n_art.errors|striptags }}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label for="{{ form.municipio.id_for_label }}" class="form-label-professional">Município</label>
                {{ form.municipio }}
                {% if form.municipio.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.municipio.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-2">
                <label for="{{ form.uf.id_for_label }}" class="form-label-professional">UF</label>
                {{ form.uf }}
                {% if form.uf.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.uf.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label for="{{ form.uc_os.id_for_label }}" class="form-label-professional">UC/OS</label>
                {{ form.uc_os }}
                {% if form.uc_os.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.uc_os.errors|striptags }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label for="{{ form.oc.id_for_label }}" class="form-label-professional">OC</label>
                {{ form.oc }}
                {% if form.oc.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.oc.errors|striptags }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PRODUTOS -->
      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#produtos">
          Produtos
        </div>
        <div id="produtos" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="mb-3">
              {{ produto_formset.management_form }}
              <div id="produtos-container">
                {% for produto_form in produto_formset %}
                  <div class="row g-2 produto-form border rounded p-2 mb-3 position-relative">
                    <div class="col-md-6">
                      {{ produto_form.produto.label_tag }} {{ produto_form.produto }}
                    </div>
                    <div class="col-md-3">
                      {{ produto_form.quantidade.label_tag }} {{ produto_form.quantidade }}
                    </div>
                    <div class="col-md-3 d-flex align-items-center">
                      <label class="form-check-label me-2">Dar baixa no estoque</label>
                      <input type="hidden" name="form-{{ forloop.counter0 }}-baixa" value="nao" class="campo-baixa" />
                      <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle-baixa" data-index="{{ forloop.counter0 }}">
                        Não
                      </button>
                    </div>
                    
                    <!-- Campo DELETE oculto -->
                    <input type="hidden" name="form-{{ forloop.counter0 }}-acao" value="mantem" class="campo-acao" />
                    <!-- Botão de excluir -->
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-2 btn-remove-produto" title="Remover produto"></button>
                  </div>
                {% endfor %}
              </div>

              <!-- TEMPLATE OCULTO para clonagem -->
              <div id="produto-template" class="row g-2 produto-form border rounded p-2 mb-3 position-relative" style="display:none;">
                <div class="col-md-6">
                  <label for="id_form-__prefix__-produto">Produto</label>
                  <select name="form-__prefix__-produto" id="id_form-__prefix__-produto" class="form-select"></select>
                </div>
                <div class="col-md-3">
                  <label for="id_form-__prefix__-quantidade">Quantidade</label>
                  <input type="number" name="form-__prefix__-quantidade" id="id_form-__prefix__-quantidade" class="form-control" />
                </div>
                <div class="col-md-3 d-flex align-items-center">
                  <label class="form-check-label me-2">Dar baixa no estoque</label>
                  <input type="hidden" name="form-__prefix__-baixa" value="nao" class="campo-baixa" />
                  <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle-baixa" data-index="__prefix__">
                    Não
                  </button>
                </div>

                <!-- Campo personalizado de ação -->
                <input type="hidden" name="form-__prefix__-acao" value="mantem" class="campo-acao" />

                <!-- Botão de excluir -->
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2 btn-remove-produto" title="Remover produto"></button>
              </div>

              <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-produto">+ Adicionar Produto</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card-collapse">
        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#seg_ativ_obs">
          Anexo e Observação
        </div>
        <div id="seg_ativ_obs" class="collapse" data-bs-parent="#formAccordion">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-12">
                <label for="{{ form.arquivo.id_for_label }}" class="form-label-professional">Arquivo</label>
                {{ form.arquivo }}
                {% if form.arquivo.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.arquivo.errors|striptags }}
                </div>
                {% endif %}
              </div> 
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-12">
                <label for="{{ form.descricao.id_for_label }}" class="form-label-professional">Descrição</label>
                {{ form.descricao }}
                {% if form.descricao.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.descricao.errors|striptags }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="text-end mt-3">
      <button type="submit" class="btn btn-dark-custom btn-sm w-auto">
        <i class="fas fa-save me-2"></i>Salvar Os
      </button>
    </div>
  </form>
</div>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.getElementById('produtos-container');
  const addBtn = document.getElementById('add-produto');
  const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
  const template = document.getElementById('produto-template');
  const form = document.querySelector('form');

  function atualizarEventosRemocao() {
    const botoes = container.querySelectorAll('.btn-remove-produto');
    botoes.forEach(btn => {
      btn.onclick = function () {
        const formRow = btn.closest('.produto-form');
        const acaoField = formRow.querySelector('input.campo-acao');
        if (acaoField) {
          acaoField.value = 'delete';
        }
        formRow.style.display = 'none';
      };
    });
  }

  function atualizarEventosToggleBaixa() {
    const botoesBaixa = container.querySelectorAll('.btn-toggle-baixa');
    botoesBaixa.forEach(btn => {
      btn.onclick = () => {
        const index = btn.getAttribute('data-index');
        const campoHidden = container.querySelector(`input[name="form-${index}-baixa"]`);
        if (!campoHidden) return;

        if (campoHidden.value === 'nao') {
          campoHidden.value = 'sim';
          btn.textContent = 'Sim';
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-outline-primary');
        } else {
          campoHidden.value = 'nao';
          btn.textContent = 'Não';
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-outline-secondary');
        }
      };
    });
  }

  addBtn.addEventListener('click', function () {
    const formCount = parseInt(totalForms.value);

    // Clona o template oculto
    const newForm = template.cloneNode(true);
    newForm.style.display = 'flex';
    newForm.id = "";

    // Substitui __prefix__ por formCount
    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formCount);

    // Corrige atributos for, name e id
    newForm.querySelectorAll('input, select, label, button').forEach(el => {
      if (el.hasAttribute('for')) {
        el.setAttribute('for', el.getAttribute('for').replace('__prefix__', formCount));
      }
      if (el.name) {
        el.name = el.name.replace('__prefix__', formCount);
      }
      if (el.id) {
        el.id = el.id.replace('__prefix__', formCount);
      }
      // Corrige data-index do botão toggle baixa
      if (el.classList.contains('btn-toggle-baixa')) {
        el.setAttribute('data-index', formCount);
        // Inicializa texto e classes do botão
        el.textContent = 'Não';
        el.classList.remove('btn-outline-primary');
        el.classList.add('btn-outline-secondary');
      }
    });

    // Copiar opções do primeiro select real para o novo
    const primeiroSelect = container.querySelector('select');
    const novoSelect = newForm.querySelector('select');
    if (primeiroSelect && novoSelect) {
      novoSelect.innerHTML = primeiroSelect.innerHTML;
    }

    container.appendChild(newForm);
    totalForms.value = formCount + 1;
    atualizarEventosRemocao();
    atualizarEventosToggleBaixa();
  });

  form.addEventListener('submit', function () {
    // Garante que todos os campos DELETE marcados sejam habilitados
    const deletes = container.querySelectorAll('input[type="checkbox"][name$="-DELETE"]');
    deletes.forEach(input => {
      if (input.checked) {
        input.disabled = false;
      }
    });
  });

  atualizarEventosRemocao();
  atualizarEventosToggleBaixa();
});
</script>



{% endblock %}
